"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var s=t[o];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,_toPropertyKey(s.key),s)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var o=e[Symbol.toPrimitive];if(void 0===o)return("string"===t?String:Number)(e);o=o.call(e,t||"default");if("object"!==_typeof(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}var MenuButtonActions=function(){function i(e){_classCallCheck(this,i),this.domNode=e,this.buttonNode=e.querySelector("button"),this.menuNode=e.querySelector('[role="menu"]'),this.menuitemNodes=[],this.firstMenuitem=!1,this.lastMenuitem=!1,this.firstChars=[],this.buttonNode.addEventListener("keydown",this.onButtonKeydown.bind(this)),this.buttonNode.addEventListener("click",this.onButtonClick.bind(this));for(var t=e.querySelectorAll('[role="menuitem"]'),o=0;o<t.length;o++){var s=t[o];this.menuitemNodes.push(s),s.tabIndex=-1,this.firstChars.push(s.textContent.trim()[0].toLowerCase()),s.addEventListener("keydown",this.onMenuitemKeydown.bind(this)),s.addEventListener("click",this.onMenuitemClick.bind(this)),s.addEventListener("mouseover",this.onMenuitemMouseover.bind(this)),this.firstMenuitem||(this.firstMenuitem=s),this.lastMenuitem=s}e.addEventListener("focusin",this.onFocusin.bind(this)),e.addEventListener("focusout",this.onFocusout.bind(this)),window.addEventListener("mousedown",this.onBackgroundMousedown.bind(this),!0)}return _createClass(i,[{key:"setFocusToMenuitem",value:function(t){this.menuitemNodes.forEach(function(e){e===t?(e.tabIndex=0,t.focus()):e.tabIndex=-1})}},{key:"setFocusToFirstMenuitem",value:function(){this.setFocusToMenuitem(this.firstMenuitem)}},{key:"setFocusToLastMenuitem",value:function(){this.setFocusToMenuitem(this.lastMenuitem)}},{key:"setFocusToPreviousMenuitem",value:function(e){e=e===this.firstMenuitem?this.lastMenuitem:(e=this.menuitemNodes.indexOf(e),this.menuitemNodes[e-1]);return this.setFocusToMenuitem(e),e}},{key:"setFocusToNextMenuitem",value:function(e){e=e===this.lastMenuitem?this.firstMenuitem:(e=this.menuitemNodes.indexOf(e),this.menuitemNodes[e+1]);return this.setFocusToMenuitem(e),e}},{key:"setFocusByFirstCharacter",value:function(e,t){1<t.length||(t=t.toLowerCase(),(e=this.menuitemNodes.indexOf(e)+1)>=this.menuitemNodes.length&&(e=0),-1<(e=-1===(e=this.firstChars.indexOf(t,e))?this.firstChars.indexOf(t,0):e)&&this.setFocusToMenuitem(this.menuitemNodes[e]))}},{key:"getIndexFirstChars",value:function(e,t){for(var o=e;o<this.firstChars.length;o++)if(t===this.firstChars[o])return o;return-1}},{key:"openPopup",value:function(){this.menuNode.style.display="block",this.buttonNode.setAttribute("aria-expanded","true")}},{key:"closePopup",value:function(){this.isOpen()&&(this.buttonNode.removeAttribute("aria-expanded"),this.menuNode.style.display="none")}},{key:"isOpen",value:function(){return"true"===this.buttonNode.getAttribute("aria-expanded")}},{key:"onFocusin",value:function(){this.domNode.classList.add("focus")}},{key:"onFocusout",value:function(){this.domNode.classList.remove("focus")}},{key:"onButtonKeydown",value:function(e){var t=!1;switch(e.key){case" ":case"Enter":case"ArrowDown":case"Down":this.openPopup(),this.setFocusToFirstMenuitem(),t=!0;break;case"Esc":case"Escape":this.closePopup(),t=!0;break;case"Up":case"ArrowUp":this.openPopup(),this.setFocusToLastMenuitem(),t=!0}t&&(e.stopPropagation(),e.preventDefault())}},{key:"onButtonClick",value:function(e){this.isOpen()?(this.closePopup(),this.buttonNode.focus()):(this.openPopup(),this.setFocusToFirstMenuitem()),e.stopPropagation(),e.preventDefault()}},{key:"onMenuitemKeydown",value:function(e){var t=e.currentTarget,o=e.key,s=!1;function i(e){return 1===e.length&&e.match(/\S/)}if(!(e.ctrlKey||e.altKey||e.metaKey)){if(e.shiftKey)i(o)&&(this.setFocusByFirstCharacter(t,o),s=!0),"Tab"===e.key&&(this.buttonNode.focus(),this.closePopup(),s=!0);else switch(o){case" ":case"Enter":this.closePopup(),this.performMenuAction(t),this.buttonNode.focus(),s=!0;break;case"Esc":case"Escape":this.closePopup(),this.buttonNode.focus(),s=!0;break;case"Up":case"ArrowUp":this.setFocusToPreviousMenuitem(t),s=!0;break;case"ArrowDown":case"Down":this.setFocusToNextMenuitem(t),s=!0;break;case"Home":case"PageUp":this.setFocusToFirstMenuitem(),s=!0;break;case"End":case"PageDown":this.setFocusToLastMenuitem(),s=!0;break;case"Tab":this.closePopup();break;default:i(o)&&(this.setFocusByFirstCharacter(t,o),s=!0)}s&&(e.stopPropagation(),e.preventDefault())}}},{key:"onMenuitemClick",value:function(e){e=e.currentTarget;this.closePopup(),this.buttonNode.focus(),this.performMenuAction(e)}},{key:"onMenuitemMouseover",value:function(e){e.currentTarget.focus()}},{key:"onBackgroundMousedown",value:function(e){this.domNode.contains(e.target)||this.isOpen()&&(this.closePopup(),this.buttonNode.focus())}}]),i}();window.addEventListener("load",function(){for(var e=document.querySelectorAll(".menu-button-actions"),t=0;t<e.length;t++)new MenuButtonActions(e[t])});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRyb3Bkb3duLmpzIl0sIm5hbWVzIjpbIl90eXBlb2YiLCJvYmoiLCJTeW1ib2wiLCJpdGVyYXRvciIsImNvbnN0cnVjdG9yIiwicHJvdG90eXBlIiwiX2NsYXNzQ2FsbENoZWNrIiwiaW5zdGFuY2UiLCJDb25zdHJ1Y3RvciIsIlR5cGVFcnJvciIsIl9kZWZpbmVQcm9wZXJ0aWVzIiwidGFyZ2V0IiwicHJvcHMiLCJpIiwibGVuZ3RoIiwiZGVzY3JpcHRvciIsImVudW1lcmFibGUiLCJjb25maWd1cmFibGUiLCJ3cml0YWJsZSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiX3RvUHJvcGVydHlLZXkiLCJrZXkiLCJfY3JlYXRlQ2xhc3MiLCJwcm90b1Byb3BzIiwic3RhdGljUHJvcHMiLCJhcmciLCJfdG9QcmltaXRpdmUiLCJTdHJpbmciLCJpbnB1dCIsImhpbnQiLCJwcmltIiwidG9QcmltaXRpdmUiLCJ1bmRlZmluZWQiLCJOdW1iZXIiLCJyZXMiLCJjYWxsIiwiTWVudUJ1dHRvbkFjdGlvbnMiLCJ0aGlzIiwicXVlcnlTZWxlY3RvciIsImRvbU5vZGUiLCJidXR0b25Ob2RlIiwibWVudU5vZGUiLCJtZW51aXRlbU5vZGVzIiwiYmluZCIsImxhc3RNZW51aXRlbSIsImFkZEV2ZW50TGlzdGVuZXIiLCJmaXJzdENoYXJzIiwibm9kZXMiLCJwdXNoIiwibWVudWl0ZW0iLCJ0YWJJbmRleCIsInRleHRDb250ZW50Iiwib25NZW51aXRlbUNsaWNrIiwiZmlyc3RNZW51aXRlbSIsIm9uTWVudWl0ZW1LZXlkb3duIiwib25Gb2N1c2luIiwibmV3TWVudWl0ZW0iLCJvbkZvY3Vzb3V0Iiwid2luZG93Iiwib25CYWNrZ3JvdW5kTW91c2Vkb3duIiwic2V0Rm9jdXNUb0ZpcnN0TWVudWl0ZW0iLCJzZXRGb2N1c1RvTWVudWl0ZW0iLCJ2YWx1ZSIsInNldEZvY3VzVG9MYXN0TWVudWl0ZW0iLCJpdGVtIiwiZm9jdXMiLCJjdXJyZW50TWVudWl0ZW0iLCJpbmRleCIsImluZGV4T2YiLCJzdGFydCIsImNoYXIiLCJ0b0xvd2VyQ2FzZSIsImNsb3NlUG9wdXAiLCJpc09wZW4iLCJzdGFydEluZGV4IiwicmVtb3ZlQXR0cmlidXRlIiwic3R5bGUiLCJkaXNwbGF5Iiwic2V0QXR0cmlidXRlIiwiZ2V0QXR0cmlidXRlIiwiY2xhc3NMaXN0IiwiYWRkIiwiZXZlbnQiLCJmbGFnIiwib3BlblBvcHVwIiwic3RvcFByb3BhZ2F0aW9uIiwicHJldmVudERlZmF1bHQiLCJpc1ByaW50YWJsZUNoYXJhY3RlciIsInN0ciIsInNldEZvY3VzQnlGaXJzdENoYXJhY3RlciIsInRndCIsIm1hdGNoIiwicGVyZm9ybU1lbnVBY3Rpb24iLCJtZXRhS2V5Iiwic2hpZnRLZXkiLCJzZXRGb2N1c1RvUHJldmlvdXNNZW51aXRlbSIsInNldEZvY3VzVG9OZXh0TWVudWl0ZW0iLCJvbk1lbnVpdGVtTW91c2VvdmVyIiwiY3VycmVudFRhcmdldCIsImNvbnRhaW5zIiwibWVudUJ1dHRvbnMiLCJkb2N1bWVudCIsInF1ZXJ5U2VsZWN0b3JBbGwiXSwibWFwcGluZ3MiOiJBQVNBLGFBQVksU0FBQUEsUUFBQUMsR0FBQSxPQUFBRCxRQUFBLFlBQUEsT0FBQUUsUUFBQSxVQUFBLE9BQUFBLE9BQUFDLFNBQUEsU0FBQUYsR0FBQSxPQUFBLE9BQUFBLENBQUEsRUFBQSxTQUFBQSxHQUFBLE9BQUFBLEdBQUEsWUFBQSxPQUFBQyxRQUFBRCxFQUFBRyxjQUFBRixRQUFBRCxJQUFBQyxPQUFBRyxVQUFBLFNBQUEsT0FBQUosQ0FBQSxHQUFBQSxDQUFBLENBQUEsQ0FBQSxTQUFBSyxnQkFBQUMsRUFBQUMsR0FBQSxHQUFBLEVBQUFELGFBQUFDLEdBQUEsTUFBQSxJQUFBQyxVQUFBLG1DQUFBLENBQUEsQ0FBQSxTQUFBQyxrQkFBQUMsRUFBQUMsR0FBQSxJQUFBLElBQUFDLEVBQUEsRUFBQUEsRUFBQUQsRUFBQUUsT0FBQUQsQ0FBQSxHQUFBLENBQUEsSUFBQUUsRUFBQUgsRUFBQUMsR0FBQUUsRUFBQUMsV0FBQUQsRUFBQUMsWUFBQSxDQUFBLEVBQUFELEVBQUFFLGFBQUEsQ0FBQSxFQUFBLFVBQUFGLElBQUFBLEVBQUFHLFNBQUEsQ0FBQSxHQUFBQyxPQUFBQyxlQUFBVCxFQUFBVSxlQUFBTixFQUFBTyxHQUFBLEVBQUFQLENBQUEsQ0FBQSxDQUFBLENBQUEsU0FBQVEsYUFBQWYsRUFBQWdCLEVBQUFDLEdBQUEsT0FBQUQsR0FBQWQsa0JBQUFGLEVBQUFILFVBQUFtQixDQUFBLEVBQUFDLEdBQUFmLGtCQUFBRixFQUFBaUIsQ0FBQSxFQUFBTixPQUFBQyxlQUFBWixFQUFBLFlBQUEsQ0FBQVUsU0FBQSxDQUFBLENBQUEsQ0FBQSxFQUFBVixDQUFBLENBQUEsU0FBQWEsZUFBQUssR0FBQUosRUFBQUssYUFBQUQsRUFBQSxRQUFBLEVBQUEsTUFBQSxXQUFBMUIsUUFBQXNCLENBQUEsRUFBQUEsRUFBQU0sT0FBQU4sQ0FBQSxDQUFBLENBQUEsU0FBQUssYUFBQUUsRUFBQUMsR0FBQSxHQUFBLFdBQUE5QixRQUFBNkIsQ0FBQSxHQUFBLE9BQUFBLEVBQUEsT0FBQUEsRUFBQSxJQUFBRSxFQUFBRixFQUFBM0IsT0FBQThCLGFBQUEsR0FBQUMsS0FBQUEsSUFBQUYsRUFBQSxPQUFBLFdBQUFELEVBQUFGLE9BQUFNLFFBQUFMLENBQUEsRUFBQU0sRUFBQUosRUFBQUssS0FBQVAsRUFBQUMsR0FBQSxTQUFBLEVBQUEsR0FBQSxXQUFBOUIsUUFBQW1DLENBQUEsRUFBQSxPQUFBQSxFQUFBLE1BQUEsSUFBQTFCLFVBQUEsOENBQUEsQ0FBQSxDQUFBLElBQUM0QixrQkFBQSxXQUFBLFNBQUFBLEVBQUEvQixHQUFBQyxnQkFBQUEsS0FBQUEsQ0FBQUEsRUFBQStCLEtBQUE1QixRQUFBQSxFQUFBNEIsS0FBQWpCLFdBQUFLLEVBQUFhLGNBQUFaLFFBQUFELEVBQUFZLEtBQUFYLFNBQUFFLEVBQUFDLGNBQUE5QixlQUFBLEVBRVBxQyxLQUFBQSxjQUFpQixHQUNuQkMsS0FBQUQsY0FBWUcsQ0FBQUEsRUFBU2xDLEtBQUFBLGFBQUErQixDQUFBQSxFQUNiQyxLQUFDRSxXQUFpQixHQUVsQkYsS0FBQ0csV0FBYUQsaUJBQ2JFLFVBQ0FDLEtBQUFBLGdCQUFrQkMsS0FBQU4sSUFBQSxDQUFBLEVBRW5CQSxLQUFDTyxXQUFlQyxpQkFDZkMsUUFFQU4sS0FBQUEsY0FBV0ssS0FBZ0JSLElBQzVCLENBQUEsRUFZQSxJQUZKLElBQUtVLEVBQVduQyxFQUFJbUMsaUJBQW1CLG1CQUFBLEVBRTlCTCxFQUFBQSxFQUFhOUIsRUFBQ29DLEVBQUtDLE9BQVNyQyxDQUFBLEdBQUEsQ0FDakNxQyxJQUFTQyxFQUFZSCxFQUFDbkMsR0FDakJrQyxLQUFBQSxjQUFnQkcsS0FBU0UsQ0FBQUEsRUFFOUJGLEVBQVNKLFNBQ0wsQ0FBQSxFQUlKSSxLQUFTSixXQUFBQSxLQUFpQkksRUFBU0UsWUFBS0MsS0FBQUEsRUFBZSxHQUFDVCxZQUFXLENBQUEsRUFPOURNLEVBQUtJLGlCQUNEQSxVQUNUaEIsS0FBQWlCLGtCQUFBWCxLQUFBTixJQUFBLENBQUEsRUFJSVEsRUFBQUEsaUJBQTBCLFFBQU9VLEtBQUFBLGdCQUFxQlosS0FBQU4sSUFBQSxDQUFBLEVBR3ZEUSxFQUFBQSxpQkFLWCxZQUFDVCxLQUFBQSxvQkFBQU8sS0FBQU4sSUFBQSxDQUFBLEVBR1FLLEtBQUFBLGdCQUNPTCxLQUFLbUIsY0FBYVAsR0FFdEJPLEtBQUFBLGFBQW1CUCxDQUN2QixDQUVBVixFQUFBTSxpQkFBQSxVQUFBUixLQUFBa0IsVUFBQVosS0FBQU4sSUFBQSxDQUFBLEVBQ0ZFLEVBQUFNLGlCQUFBLFdBQUFSLEtBQUFvQixXQUFBZCxLQUFBTixJQUFBLENBQUEsRUFDTHFCLE9BQUFiLGlCQUFBLFlBRURSLEtBQUFzQixzQkFBQUMsS0FBQXZCLElBQTBCLEVBQ2pCd0IsQ0FBQUEsQ0FBQUEsQ0FDUixDQWdRQSxPQWhRQXZDLGFBQUFjLEVBQUEsQ0FBQSxDQUFBZixJQUFBLHFCQUFBeUMsTUFBQUEsU0FFREMsR0FDSTFCLEtBQUt3QixjQUFBQSxRQUF3QmpCLFNBQUFBLEdBQ2pDb0IsSUFBQVIsR0FBQ1EsRUFBQWQsU0FBQSxFQUFBTSxFQUFBUyxNQUFBLEdBR09ULEVBQVdOLFNBQU8sQ0FBQSxDQUdsQk0sQ0FBQUEsQ0FkUixDQUFDLEVBQUEsQ0FBQW5DLElBQUEsMEJBQUF5QyxNQUVELFdBZ0JJekIsS0FBQXdCLG1CQUFBeEIsS0FBQWdCLGFBQUEsQ0FkSixDQUFDLEVBQUEsQ0FBQWhDLElBQUEseUJBQUF5QyxNQW1CRCxXQUFDekIsS0FBQXdCLG1CQUFBeEIsS0FBQU8sWUFBQSxDQUFBdkIsQ0FBQUEsRUFBQUEsQ0FBQUEsSUFBQUEsNkJBQUFBLE1BYkQsU0FnQjBCNkMsR0FLbEJDLEVBREhELElBQU03QixLQUFBZ0IsY0FDVVgsS0FBQUEsY0FFakJ5QixFQUFBOUIsS0FBQUssY0FBQTBCLFFBQUFGLENBQUEsRUFDS0wsS0FBbUJMLGNBQVlXLEVBQUEsSUFHdkNMLE9BQUF6QixLQUFBd0IsbUJBQUFMLENBQUEsRUFFREEsQ0FoQkEsQ0FBQyxFQUFBLENBQUFuQyxJQUFBLHlCQUFBeUMsTUFFRCxTQWtCUUksR0FLSlYsRUFwQklVLElBQW9CN0IsS0FBS08sYUFvQjdCUCxLQUFBZ0IsZUFFSWdCLEVBQVNoQyxLQUFLSyxjQUFjN0IsUUFBUXFELENBQUEsRUFDM0I3QixLQUFBSyxjQUFBeUIsRUFBQSxJQUliQSxPQXJCQTlCLEtBQUt3QixtQkFBbUJMLENBQVcsRUFxQjNCQSxDQWxCWixDQUFDLEVBQUEsQ0FBQW5DLElBQUEsMkJBQUF5QyxNQUVELFNBbUJzQkksRUFBQUksR0FoQkEsRUFBZEEsRUFBS3pELFNBdUJUeUQsRUFBQUEsRUFBQUMsWUFBQSxHQUdKRixFQUFBaEMsS0FBQUssY0FBQTBCLFFBQUFGLENBQUEsRUFBQSxJQUFBN0IsS0FBQUssY0FBQTdCLFNBQUF3RCxFQUFBLEdBV0EsQ0FBQSxHQUZBRixFQURhLENBQUEsS0FyQlRBLEVBa0JROUIsS0FBUVMsV0FBQXNCLFFBQUFFLEVBQUFELENBQUEsR0FJcEJoQyxLQUFBUyxXQUFBc0IsUUFBQUUsRUFBQSxDQUFBLEVBRUFILElBRUE5QixLQUFBd0IsbUJBQVl4QixLQUFBSyxjQUFBeUIsRUFBQSxFQWZaLENBa0JDLEVBQUEsQ0FBQTlDLElBQUEscUJBQUF5QyxNQUFBQSxTQUVEVSxFQUFhRixHQUNULElBQUksSUFBS0csRUFBTUMsRUFBSTlELEVBQUF5QixLQUFBUyxXQUFBakMsT0FBQUQsQ0FBQSxHQUNYLEdBQUM0QixJQUFXbUMsS0FBQUEsV0FBZ0IvRCxHQUMzQjZCLE9BQVNtQyxFQUVyQixNQUFBLENBQUEsQ0FBQXZELENBWkQsRUFBQSxDQUFBQSxJQUFBLFlBQUF5QyxNQUVBLFdBZ0JBekIsS0FBQUksU0FBQW1DLE1BQUFDLFFBQUEsUUFBQXhDLEtBQUFHLFdBQUFzQyxhQUFBLGdCQUFBLE1BQUEsQ0FBQXpELENBQUFBLEVBQUFBLENBQUFBLElBQUFBLGFBQUFBLE1BWEEsV0FlQWdCLEtBQUFvQyxPQUFBLElBQUNwQyxLQUFBRyxXQUFBbUMsZ0JBQUEsZUFBQSxFQUFBdEMsS0FBQUksU0FBQW1DLE1BQUFDLFFBQUEsT0FWRCxDQUFDLEVBQUEsQ0FBQXhELElBQUEsU0FBQXlDLE1BY0EsV0FBQSxNQUFBLFNBQUF6QixLQUFBRyxXQUFBdUMsYUFBQSxlQUFBLENBQUFqQixDQVJELEVBQUEsQ0FBQXpDLElBQUEsWUFBQXlDLE1BRUEsV0FjUXpCLEtBQUtFLFFBQU95QyxVQUFBQyxJQUFBLE9BQUEsQ0FacEIsQ0FBQyxFQUFBLENBQUE1RCxJQUFBLGFBQUF5QyxNQUVELFdBQ0l6QixLQWFRRSxRQUFLcUIsVUFBQUEsT0FBdUIsT0FBRSxDQVoxQyxDQUFDLEVBQUEsQ0FBQXZDLElBQUEsa0JBQUF5QyxNQUVELFNBY2tCb0IsR0FDVixJQUNJQyxFQUFLWCxDQUFBQSxFQVpiLE9BV1NVLEVBQVE3RCxLQUtiLElBQVMsSUFDVCxJQUFLLFFBQ0QsSUFBSytELFlBQ0wsSUFBS3JCLE9BQ0QxQixLQUFPK0MsVUFBQSxFQUNYL0MsS0FBQXVCLHdCQUFBLEVBRUp1QixFQUFBLENBQUEsRUFDSSxNQUdKQSxJQUFNLE1BQ05ELElBQU1HLFNBQ0FDLEtBQUFBLFdBQWdCLEVBQzFCSCxFQUFBLENBQUEsRUFDSixNQUFDLElBQUEsS0FFRCxJQUFBLFVBQ2FWLEtBQU1XLFVBQUksRUFDVlosS0FBQUEsdUJBQVksRUFDWmhDLEVBQVUsQ0FBQSxDQUluQixDQUlKMkMsSUFBQ0QsRUFBQUcsZ0JBQUEsRUFBQUgsRUFBQUksZUFBQSxFQWJELENBQUMsRUFBQSxDQUFBakUsSUFBQSxnQkFBQXlDLE1BRUQsU0FnQmVvQixHQUVYN0MsS0FBU2tELE9BQUFBLEdBQ0xsRCxLQUFPbUQsV0FBVSxFQUNyQm5ELEtBQUFHLFdBQUF5QixNQUFBLElBR0k1QixLQUFBK0MsVUFBQSxFQUNKL0MsS0FBQXVCLHdCQUFBLEdBZkFzQixFQW1CWUcsZ0JBQUNJLEVBbEJiUCxFQW1CWUksZUFBTyxDQWxCdkIsQ0FBQyxFQUFBLENBQUFqRSxJQUFBLG9CQUFBeUMsTUFFRCxTQW9CaUJ0QixHQW5CYixJQW9CUWtELEVBQUtsQixFQUFBQSxjQUNMVyxFQUFPRCxFQUFJN0QsSUFDZjhELEVBQUEsQ0FBQSxFQUVBLFNBQVE5RCxFQUFHbUUsR0FDUCxPQUFRLElBQUFBLEVBQUEzRSxRQUFBMkUsRUFBQUcsTUFBQSxJQUFBLENBbkJoQixDQUVBLEdBb0JZVCxFQUFBQSxFQUFLVSxTQUFBQSxFQUFrQkYsUUFBSVIsRUFBQVcsU0FwQnZDLENBSUEsR0FxQlFYLEVBQUtZLFNBQ0FQLEVBQVFsRSxDQUFBLElBQ0xnQixLQUFDbUMseUJBQVlrQixFQUFBckUsQ0FBQSxFQUNiOEQsRUFBQzNDLENBQUFBLEdBSUEsUUFBSjBDLEVBQUk3RCxNQUNKZ0IsS0FBQUcsV0FBU3lCLE1BQUEsRUFDTjVCLEtBQUMwRCxXQUFBQSxFQUNEWixFQUFPLENBQUEsUUFJZixPQUFLOUQsR0FDRyxJQUFDMkUsSUFDRCxJQUFHLFFBQ1AzRCxLQUFBbUMsV0FBQSxFQUVDbkMsS0FBTXVELGtCQUFBRixDQUFBLEVBQ05yRCxLQUFRRyxXQUFBeUIsTUFBQSxFQUNKTCxFQUFBQSxDQUFBQSxFQUNFLE1BR04sSUFBSyxNQUNMLElBQUEsU0FDSUcsS0FBQUEsV0FBQUEsRUFDRTFCLEtBQUlHLFdBQUF5QixNQUFBLEVBQ1hrQixFQUFBLENBQUEsRUFFTSxNQUVOLElBQUEsS0FFSixJQUFBLFVBQ1FJLEtBQUFBLDJCQUEyQkcsQ0FBQSxFQUN0QkQsRUFBQUEsQ0FBQUEsRUFDRCxNQUVSLElBQUEsWUFBTSxJQUFBLE9BRWxCcEQsS0FBQTJELHVCQUFBTixDQUFBLEVBRVVQLEVBQUEsQ0FBQSxFQUNBRSxNQUVWLElBQUEsT0FDSixJQUFBLFNBQUNoRCxLQUFBdUIsd0JBQUEsRUFBQXVCLEVBQUEsQ0FBQSxFQUVEL0IsTUFFU29CLElBQVUsTUFDVmhDLElBQVUsV0FDVm9ELEtBQUFBLHVCQUFzQixFQUMvQlQsRUFBQSxDQUFBLEVBQUMsTUFFRCxJQUFBYyxNQUNjZixLQUFNZ0IsV0FBYSxFQUNsQixNQUNkLFFBQUFYLEVBQUFsRSxDQUFBLElBRURzQyxLQUFBQSx5QkFBNkIrQixFQUFBckUsQ0FBQSxFQUNQOEUsRUFBQUEsQ0FBQUEsRUFFSyxDQUkzQmhCLElBQUNELEVBQUFHLGdCQUFBLEVBQUFqRCxFQUFBQSxlQUFBLEVBNUZHLENBZ0dSc0IsQ0FBQUEsRUFBQUEsQ0FBQUEsSUFBQUEsa0JBQUFBLE1BdkJJLFNBQWdCd0IsR0EwQmhCUSxFQUFBUixFQUFBZ0IsY0FDQTdELEtBQUFtQyxXQUFBLEVBQ0FuQyxLQUFBRyxXQUFBeUIsTUFBQSxFQUNBNUIsS0FBQXVELGtCQUFBRixDQUFBLENBeEJBLENBQUMsRUFBQSxDQUFBckUsSUFBQSxzQkFBQXlDLE1BMkJELFNBQW9Cc0MsR0FDWmhFLEVBQUFBLGNBQ0o2QixNQUFBLENBQ0osQ0FBQSxFQUFBLENBQUE1QyxJQUFBLHdCQUFBeUMsTUF2QkEsU0FBc0JvQixHQUNiN0MsS0FBS0UsUUFBUTRELFNBQVNqQixFQUFNeEUsTUFBTSxHQUMvQjJCLEtBQUtvQyxPQUFNLElBQ1hwQyxLQUFLbUMsV0FBVSxFQUNmbkMsS0FBS0csV0FBV3lCLE1BQUssRUFHakMsQ0FBQyxFQUFBLEVBQUE3QixDQUFBLEVBQUEsRUFJTHNCLE9BQU9iLGlCQUFpQixPQUFRLFdBUzVCLElBREEsSUFBSXVELEVBQWNDLFNBQVNDLGlCQUFpQixzQkFBc0IsRUFDekQxRixFQUFJLEVBQUdBLEVBQUl3RixFQUFZdkYsT0FBUUQsQ0FBQyxHQUNyQyxJQUFJd0Isa0JBQWtCZ0UsRUFBWXhGLEVBQUUsQ0FHNUMsQ0FBQyIsImZpbGUiOiJkcm9wZG93bi5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiAgIFRoaXMgY29udGVudCBpcyBsaWNlbnNlZCBhY2NvcmRpbmcgdG8gdGhlIFczQyBTb2Z0d2FyZSBMaWNlbnNlIGF0XHJcbiAqICAgaHR0cHM6Ly93d3cudzMub3JnL0NvbnNvcnRpdW0vTGVnYWwvMjAxNS9jb3B5cmlnaHQtc29mdHdhcmUtYW5kLWRvY3VtZW50XHJcbiAqXHJcbiAqICAgRmlsZTogICBtZW51LWJ1dHRvbi1hY3Rpb25zLmpzXHJcbiAqXHJcbiAqICAgRGVzYzogICBDcmVhdGVzIGEgbWVudSBidXR0b24gdGhhdCBvcGVucyBhIG1lbnUgb2YgYWN0aW9uc1xyXG4gKi9cclxuXHJcblwidXNlIHN0cmljdFwiO1xyXG5cclxuY2xhc3MgTWVudUJ1dHRvbkFjdGlvbnMge1xyXG4gICAgY29uc3RydWN0b3IoZG9tTm9kZSkge1xyXG4gICAgICAgIHRoaXMuZG9tTm9kZSA9IGRvbU5vZGU7XHJcbiAgICAgICAgLy8gdGhpcy5wZXJmb3JtTWVudUFjdGlvbiA9IHBlcmZvcm1NZW51QWN0aW9uO1xyXG4gICAgICAgIHRoaXMuYnV0dG9uTm9kZSA9IGRvbU5vZGUucXVlcnlTZWxlY3RvcihcImJ1dHRvblwiKTtcclxuICAgICAgICB0aGlzLm1lbnVOb2RlID0gZG9tTm9kZS5xdWVyeVNlbGVjdG9yKCdbcm9sZT1cIm1lbnVcIl0nKTtcclxuICAgICAgICB0aGlzLm1lbnVpdGVtTm9kZXMgPSBbXTtcclxuICAgICAgICB0aGlzLmZpcnN0TWVudWl0ZW0gPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmxhc3RNZW51aXRlbSA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuZmlyc3RDaGFycyA9IFtdO1xyXG5cclxuICAgICAgICB0aGlzLmJ1dHRvbk5vZGUuYWRkRXZlbnRMaXN0ZW5lcihcclxuICAgICAgICAgICAgXCJrZXlkb3duXCIsXHJcbiAgICAgICAgICAgIHRoaXMub25CdXR0b25LZXlkb3duLmJpbmQodGhpcylcclxuICAgICAgICApO1xyXG4gICAgICAgIHRoaXMuYnV0dG9uTm9kZS5hZGRFdmVudExpc3RlbmVyKFxyXG4gICAgICAgICAgICBcImNsaWNrXCIsXHJcbiAgICAgICAgICAgIHRoaXMub25CdXR0b25DbGljay5iaW5kKHRoaXMpXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgdmFyIG5vZGVzID0gZG9tTm9kZS5xdWVyeVNlbGVjdG9yQWxsKCdbcm9sZT1cIm1lbnVpdGVtXCJdJyk7XHJcblxyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgdmFyIG1lbnVpdGVtID0gbm9kZXNbaV07XHJcbiAgICAgICAgICAgIHRoaXMubWVudWl0ZW1Ob2Rlcy5wdXNoKG1lbnVpdGVtKTtcclxuICAgICAgICAgICAgbWVudWl0ZW0udGFiSW5kZXggPSAtMTtcclxuICAgICAgICAgICAgdGhpcy5maXJzdENoYXJzLnB1c2gobWVudWl0ZW0udGV4dENvbnRlbnQudHJpbSgpWzBdLnRvTG93ZXJDYXNlKCkpO1xyXG5cclxuICAgICAgICAgICAgbWVudWl0ZW0uYWRkRXZlbnRMaXN0ZW5lcihcclxuICAgICAgICAgICAgICAgIFwia2V5ZG93blwiLFxyXG4gICAgICAgICAgICAgICAgdGhpcy5vbk1lbnVpdGVtS2V5ZG93bi5iaW5kKHRoaXMpXHJcbiAgICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgICBtZW51aXRlbS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgdGhpcy5vbk1lbnVpdGVtQ2xpY2suYmluZCh0aGlzKSk7XHJcblxyXG4gICAgICAgICAgICBtZW51aXRlbS5hZGRFdmVudExpc3RlbmVyKFxyXG4gICAgICAgICAgICAgICAgXCJtb3VzZW92ZXJcIixcclxuICAgICAgICAgICAgICAgIHRoaXMub25NZW51aXRlbU1vdXNlb3Zlci5iaW5kKHRoaXMpXHJcbiAgICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgICBpZiAoIXRoaXMuZmlyc3RNZW51aXRlbSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5maXJzdE1lbnVpdGVtID0gbWVudWl0ZW07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5sYXN0TWVudWl0ZW0gPSBtZW51aXRlbTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGRvbU5vZGUuYWRkRXZlbnRMaXN0ZW5lcihcImZvY3VzaW5cIiwgdGhpcy5vbkZvY3VzaW4uYmluZCh0aGlzKSk7XHJcbiAgICAgICAgZG9tTm9kZS5hZGRFdmVudExpc3RlbmVyKFwiZm9jdXNvdXRcIiwgdGhpcy5vbkZvY3Vzb3V0LmJpbmQodGhpcykpO1xyXG5cclxuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcclxuICAgICAgICAgICAgXCJtb3VzZWRvd25cIixcclxuICAgICAgICAgICAgdGhpcy5vbkJhY2tncm91bmRNb3VzZWRvd24uYmluZCh0aGlzKSxcclxuICAgICAgICAgICAgdHJ1ZVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0Rm9jdXNUb01lbnVpdGVtKG5ld01lbnVpdGVtKSB7XHJcbiAgICAgICAgdGhpcy5tZW51aXRlbU5vZGVzLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHtcclxuICAgICAgICAgICAgaWYgKGl0ZW0gPT09IG5ld01lbnVpdGVtKSB7XHJcbiAgICAgICAgICAgICAgICBpdGVtLnRhYkluZGV4ID0gMDtcclxuICAgICAgICAgICAgICAgIG5ld01lbnVpdGVtLmZvY3VzKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpdGVtLnRhYkluZGV4ID0gLTE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRGb2N1c1RvRmlyc3RNZW51aXRlbSgpIHtcclxuICAgICAgICB0aGlzLnNldEZvY3VzVG9NZW51aXRlbSh0aGlzLmZpcnN0TWVudWl0ZW0pO1xyXG4gICAgfVxyXG5cclxuICAgIHNldEZvY3VzVG9MYXN0TWVudWl0ZW0oKSB7XHJcbiAgICAgICAgdGhpcy5zZXRGb2N1c1RvTWVudWl0ZW0odGhpcy5sYXN0TWVudWl0ZW0pO1xyXG4gICAgfVxyXG5cclxuICAgIHNldEZvY3VzVG9QcmV2aW91c01lbnVpdGVtKGN1cnJlbnRNZW51aXRlbSkge1xyXG4gICAgICAgIHZhciBuZXdNZW51aXRlbSwgaW5kZXg7XHJcblxyXG4gICAgICAgIGlmIChjdXJyZW50TWVudWl0ZW0gPT09IHRoaXMuZmlyc3RNZW51aXRlbSkge1xyXG4gICAgICAgICAgICBuZXdNZW51aXRlbSA9IHRoaXMubGFzdE1lbnVpdGVtO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGluZGV4ID0gdGhpcy5tZW51aXRlbU5vZGVzLmluZGV4T2YoY3VycmVudE1lbnVpdGVtKTtcclxuICAgICAgICAgICAgbmV3TWVudWl0ZW0gPSB0aGlzLm1lbnVpdGVtTm9kZXNbaW5kZXggLSAxXTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuc2V0Rm9jdXNUb01lbnVpdGVtKG5ld01lbnVpdGVtKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIG5ld01lbnVpdGVtO1xyXG4gICAgfVxyXG5cclxuICAgIHNldEZvY3VzVG9OZXh0TWVudWl0ZW0oY3VycmVudE1lbnVpdGVtKSB7XHJcbiAgICAgICAgdmFyIG5ld01lbnVpdGVtLCBpbmRleDtcclxuXHJcbiAgICAgICAgaWYgKGN1cnJlbnRNZW51aXRlbSA9PT0gdGhpcy5sYXN0TWVudWl0ZW0pIHtcclxuICAgICAgICAgICAgbmV3TWVudWl0ZW0gPSB0aGlzLmZpcnN0TWVudWl0ZW07XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaW5kZXggPSB0aGlzLm1lbnVpdGVtTm9kZXMuaW5kZXhPZihjdXJyZW50TWVudWl0ZW0pO1xyXG4gICAgICAgICAgICBuZXdNZW51aXRlbSA9IHRoaXMubWVudWl0ZW1Ob2Rlc1tpbmRleCArIDFdO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnNldEZvY3VzVG9NZW51aXRlbShuZXdNZW51aXRlbSk7XHJcblxyXG4gICAgICAgIHJldHVybiBuZXdNZW51aXRlbTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRGb2N1c0J5Rmlyc3RDaGFyYWN0ZXIoY3VycmVudE1lbnVpdGVtLCBjaGFyKSB7XHJcbiAgICAgICAgdmFyIHN0YXJ0LCBpbmRleDtcclxuXHJcbiAgICAgICAgaWYgKGNoYXIubGVuZ3RoID4gMSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjaGFyID0gY2hhci50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICAgICAgICAvLyBHZXQgc3RhcnQgaW5kZXggZm9yIHNlYXJjaCBiYXNlZCBvbiBwb3NpdGlvbiBvZiBjdXJyZW50SXRlbVxyXG4gICAgICAgIHN0YXJ0ID0gdGhpcy5tZW51aXRlbU5vZGVzLmluZGV4T2YoY3VycmVudE1lbnVpdGVtKSArIDE7XHJcbiAgICAgICAgaWYgKHN0YXJ0ID49IHRoaXMubWVudWl0ZW1Ob2Rlcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgc3RhcnQgPSAwO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gQ2hlY2sgcmVtYWluaW5nIHNsb3RzIGluIHRoZSBtZW51XHJcbiAgICAgICAgaW5kZXggPSB0aGlzLmZpcnN0Q2hhcnMuaW5kZXhPZihjaGFyLCBzdGFydCk7XHJcblxyXG4gICAgICAgIC8vIElmIG5vdCBmb3VuZCBpbiByZW1haW5pbmcgc2xvdHMsIGNoZWNrIGZyb20gYmVnaW5uaW5nXHJcbiAgICAgICAgaWYgKGluZGV4ID09PSAtMSkge1xyXG4gICAgICAgICAgICBpbmRleCA9IHRoaXMuZmlyc3RDaGFycy5pbmRleE9mKGNoYXIsIDApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gSWYgbWF0Y2ggd2FzIGZvdW5kLi4uXHJcbiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHtcclxuICAgICAgICAgICAgdGhpcy5zZXRGb2N1c1RvTWVudWl0ZW0odGhpcy5tZW51aXRlbU5vZGVzW2luZGV4XSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIFV0aWxpdGllc1xyXG5cclxuICAgIGdldEluZGV4Rmlyc3RDaGFycyhzdGFydEluZGV4LCBjaGFyKSB7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IHN0YXJ0SW5kZXg7IGkgPCB0aGlzLmZpcnN0Q2hhcnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgaWYgKGNoYXIgPT09IHRoaXMuZmlyc3RDaGFyc1tpXSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIC0xO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFBvcHVwIG1lbnUgbWV0aG9kc1xyXG5cclxuICAgIG9wZW5Qb3B1cCgpIHtcclxuICAgICAgICB0aGlzLm1lbnVOb2RlLnN0eWxlLmRpc3BsYXkgPSBcImJsb2NrXCI7XHJcbiAgICAgICAgdGhpcy5idXR0b25Ob2RlLnNldEF0dHJpYnV0ZShcImFyaWEtZXhwYW5kZWRcIiwgXCJ0cnVlXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIGNsb3NlUG9wdXAoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNPcGVuKCkpIHtcclxuICAgICAgICAgICAgdGhpcy5idXR0b25Ob2RlLnJlbW92ZUF0dHJpYnV0ZShcImFyaWEtZXhwYW5kZWRcIik7XHJcbiAgICAgICAgICAgIHRoaXMubWVudU5vZGUuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpc09wZW4oKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYnV0dG9uTm9kZS5nZXRBdHRyaWJ1dGUoXCJhcmlhLWV4cGFuZGVkXCIpID09PSBcInRydWVcIjtcclxuICAgIH1cclxuXHJcbiAgICAvLyBNZW51IGV2ZW50IGhhbmRsZXJzXHJcblxyXG4gICAgb25Gb2N1c2luKCkge1xyXG4gICAgICAgIHRoaXMuZG9tTm9kZS5jbGFzc0xpc3QuYWRkKFwiZm9jdXNcIik7XHJcbiAgICB9XHJcblxyXG4gICAgb25Gb2N1c291dCgpIHtcclxuICAgICAgICB0aGlzLmRvbU5vZGUuY2xhc3NMaXN0LnJlbW92ZShcImZvY3VzXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uQnV0dG9uS2V5ZG93bihldmVudCkge1xyXG4gICAgICAgIHZhciBrZXkgPSBldmVudC5rZXksXHJcbiAgICAgICAgICAgIGZsYWcgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgc3dpdGNoIChrZXkpIHtcclxuICAgICAgICAgICAgY2FzZSBcIiBcIjpcclxuICAgICAgICAgICAgY2FzZSBcIkVudGVyXCI6XHJcbiAgICAgICAgICAgIGNhc2UgXCJBcnJvd0Rvd25cIjpcclxuICAgICAgICAgICAgY2FzZSBcIkRvd25cIjpcclxuICAgICAgICAgICAgICAgIHRoaXMub3BlblBvcHVwKCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldEZvY3VzVG9GaXJzdE1lbnVpdGVtKCk7XHJcbiAgICAgICAgICAgICAgICBmbGFnID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgY2FzZSBcIkVzY1wiOlxyXG4gICAgICAgICAgICBjYXNlIFwiRXNjYXBlXCI6XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlUG9wdXAoKTtcclxuICAgICAgICAgICAgICAgIGZsYWcgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICBjYXNlIFwiVXBcIjpcclxuICAgICAgICAgICAgY2FzZSBcIkFycm93VXBcIjpcclxuICAgICAgICAgICAgICAgIHRoaXMub3BlblBvcHVwKCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldEZvY3VzVG9MYXN0TWVudWl0ZW0oKTtcclxuICAgICAgICAgICAgICAgIGZsYWcgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoZmxhZykge1xyXG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgb25CdXR0b25DbGljayhldmVudCkge1xyXG4gICAgICAgIGlmICh0aGlzLmlzT3BlbigpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cCgpO1xyXG4gICAgICAgICAgICB0aGlzLmJ1dHRvbk5vZGUuZm9jdXMoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLm9wZW5Qb3B1cCgpO1xyXG4gICAgICAgICAgICB0aGlzLnNldEZvY3VzVG9GaXJzdE1lbnVpdGVtKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uTWVudWl0ZW1LZXlkb3duKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIHRndCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQsXHJcbiAgICAgICAgICAgIGtleSA9IGV2ZW50LmtleSxcclxuICAgICAgICAgICAgZmxhZyA9IGZhbHNlO1xyXG5cclxuICAgICAgICBmdW5jdGlvbiBpc1ByaW50YWJsZUNoYXJhY3RlcihzdHIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHN0ci5sZW5ndGggPT09IDEgJiYgc3RyLm1hdGNoKC9cXFMvKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChldmVudC5jdHJsS2V5IHx8IGV2ZW50LmFsdEtleSB8fCBldmVudC5tZXRhS2V5KSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChldmVudC5zaGlmdEtleSkge1xyXG4gICAgICAgICAgICBpZiAoaXNQcmludGFibGVDaGFyYWN0ZXIoa2V5KSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRGb2N1c0J5Rmlyc3RDaGFyYWN0ZXIodGd0LCBrZXkpO1xyXG4gICAgICAgICAgICAgICAgZmxhZyA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChldmVudC5rZXkgPT09IFwiVGFiXCIpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYnV0dG9uTm9kZS5mb2N1cygpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwKCk7XHJcbiAgICAgICAgICAgICAgICBmbGFnID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHN3aXRjaCAoa2V5KSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwiIFwiOlxyXG4gICAgICAgICAgICAgICAgY2FzZSBcIkVudGVyXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJmb3JtTWVudUFjdGlvbih0Z3QpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYnV0dG9uTm9kZS5mb2N1cygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGZsYWcgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGNhc2UgXCJFc2NcIjpcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJFc2NhcGVcIjpcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlUG9wdXAoKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmJ1dHRvbk5vZGUuZm9jdXMoKTtcclxuICAgICAgICAgICAgICAgICAgICBmbGFnID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgICAgICBjYXNlIFwiVXBcIjpcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJBcnJvd1VwXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRGb2N1c1RvUHJldmlvdXNNZW51aXRlbSh0Z3QpO1xyXG4gICAgICAgICAgICAgICAgICAgIGZsYWcgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGNhc2UgXCJBcnJvd0Rvd25cIjpcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJEb3duXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRGb2N1c1RvTmV4dE1lbnVpdGVtKHRndCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZmxhZyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSBcIkhvbWVcIjpcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJQYWdlVXBcIjpcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEZvY3VzVG9GaXJzdE1lbnVpdGVtKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZmxhZyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSBcIkVuZFwiOlxyXG4gICAgICAgICAgICAgICAgY2FzZSBcIlBhZ2VEb3duXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRGb2N1c1RvTGFzdE1lbnVpdGVtKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZmxhZyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSBcIlRhYlwiOlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzUHJpbnRhYmxlQ2hhcmFjdGVyKGtleSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRGb2N1c0J5Rmlyc3RDaGFyYWN0ZXIodGd0LCBrZXkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmbGFnID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChmbGFnKSB7XHJcbiAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBvbk1lbnVpdGVtQ2xpY2soZXZlbnQpIHtcclxuICAgICAgICB2YXIgdGd0ID0gZXZlbnQuY3VycmVudFRhcmdldDtcclxuICAgICAgICB0aGlzLmNsb3NlUG9wdXAoKTtcclxuICAgICAgICB0aGlzLmJ1dHRvbk5vZGUuZm9jdXMoKTtcclxuICAgICAgICB0aGlzLnBlcmZvcm1NZW51QWN0aW9uKHRndCk7XHJcbiAgICB9XHJcblxyXG4gICAgb25NZW51aXRlbU1vdXNlb3ZlcihldmVudCkge1xyXG4gICAgICAgIHZhciB0Z3QgPSBldmVudC5jdXJyZW50VGFyZ2V0O1xyXG4gICAgICAgIHRndC5mb2N1cygpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uQmFja2dyb3VuZE1vdXNlZG93bihldmVudCkge1xyXG4gICAgICAgIGlmICghdGhpcy5kb21Ob2RlLmNvbnRhaW5zKGV2ZW50LnRhcmdldCkpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaXNPcGVuKCkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cCgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5idXR0b25Ob2RlLmZvY3VzKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbi8vIEluaXRpYWxpemUgbWVudSBidXR0b25zXHJcbndpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwibG9hZFwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImFjdGlvbl9vdXRwdXRcIikudmFsdWUgPSBcIm5vbmVcIjtcclxuXHJcbiAgICAvLyBmdW5jdGlvbiBwZXJmb3JtTWVudUFjdGlvbihub2RlKSB7XHJcbiAgICAvLyAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJhY3Rpb25fb3V0cHV0XCIpLnZhbHVlID1cclxuICAgIC8vICAgICAgICAgbm9kZS50ZXh0Q29udGVudC50cmltKCk7XHJcbiAgICAvLyB9XHJcblxyXG4gICAgdmFyIG1lbnVCdXR0b25zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIi5tZW51LWJ1dHRvbi1hY3Rpb25zXCIpO1xyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZW51QnV0dG9ucy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIG5ldyBNZW51QnV0dG9uQWN0aW9ucyhtZW51QnV0dG9uc1tpXSk7XHJcbiAgICAgICAgLy8gbmV3IE1lbnVCdXR0b25BY3Rpb25zKG1lbnVCdXR0b25zW2ldLCBwZXJmb3JtTWVudUFjdGlvbik7XHJcbiAgICB9XHJcbn0pO1xyXG4iXX0=
